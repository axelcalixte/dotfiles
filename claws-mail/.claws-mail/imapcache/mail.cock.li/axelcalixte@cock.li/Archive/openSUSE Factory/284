Return-Path: <opensuse-factory+bounces-96121-axelcalixte=cock.li@opensuse.org>
Delivered-To: axelcalixte@cock.li
Received: by mx1.cock.li (Postfix, from userid 65534)
	id 955BF82468; Fri, 21 Aug 2020 11:51:11 +0000 (UTC)
X-Spam-Checker-Version: SpamAssassin 3.4.2 (2018-09-13) on de8f7fd56dc0
X-Spam-Level: 
X-Spam-Status: No, score=-1.6 required=5.0 tests=BAYES_50,DKIM_SIGNED,
	MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,RCVD_IN_DNSWL_MED,
	RCVD_IN_MSPIKE_H4,RCVD_IN_MSPIKE_WL,RDNS_NONE,T_DKIM_INVALID,
	URIBL_BLOCKED shortcircuit=_SCTYPE_ autolearn=disabled version=3.4.2
Received: from hydra.opensuse.org (unknown [195.135.221.145])
	by mx1.cock.li (Postfix) with ESMTPS id 1AD5A823D2
	for <axelcalixte@cock.li>; Fri, 21 Aug 2020 11:51:05 +0000 (UTC)
Authentication-Results: mx1.cock.li;
	dkim=fail reason="signature verification failed" (1024-bit key; unprotected) header.d=suse.com header.i=@suse.com header.b="bQpwMhNL";
	dkim-atps=neutral
Received: from lists5.opensuse.org (baloo.infra.opensuse.org [192.168.47.38])
	by hydra.opensuse.org (Postfix) with ESMTP id 5630B20DCD
	for <axelcalixte@cock.li>; Fri, 21 Aug 2020 11:51:04 +0000 (UTC)
Received: from baloo.infra.opensuse.org (localhost [127.0.0.1])
	by lists5.opensuse.org (Postfix) with ESMTP id 3D382119C9;
	Fri, 21 Aug 2020 11:51:04 +0000 (UTC)
X-Original-To: opensuse-factory@lists5.opensuse.org
Delivered-To: opensuse-factory@lists5.opensuse.org
Received: from mx2.opensuse.org (unknown [192.168.47.96])
	by lists5.opensuse.org (Postfix) with ESMTP id 3415A119C9
	for <opensuse-factory@lists5.opensuse.org>; Fri, 21 Aug 2020 11:51:04 +0000 (UTC)
Received: from mx2.opensuse.org (localhost [127.0.0.1])
	by mx2.opensuse.org (Postfix) with ESMTP id 9BA76710
	for <opensuse-factory@opensuse.org>; Fri, 21 Aug 2020 11:51:00 +0000 (UTC)
Received: from de-smtp-delivery-102.mimecast.com (de-smtp-delivery-102.mimecast.com [51.163.158.102])
	(using TLSv1.2 with cipher ECDHE-ECDSA-AES256-SHA384 (256/256 bits))
	(No client certificate requested)
	by mx2.opensuse.org (Postfix) with ESMTPS
	for <opensuse-factory@opensuse.org>; Fri, 21 Aug 2020 11:51:00 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=suse.com; s=mimecast20200619;
	t=1598010660;
	h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
	 to:to:cc:mime-version:mime-version:content-type:content-type:
	 content-transfer-encoding:content-transfer-encoding;
	bh=2C830VDPw2ZVUFr1h2DS3Hdh/c9bxaIApSI1yjlLUEM=;
	b=bQpwMhNLp6FVA3M0llKBW7vDmBt3bpUJo1gkx35mH80zKME/jAbuMrKij11h2ELpEJ8v80
	1Zfn6PdgRbJjNB23a/CZ0h/8vYFN8EeJpVtUhsRuER7rJJPXdfubNE949R2gy47JyPiPJn
	UH5IDSYECu/yYY9zekG1BJK6vZgBw2Y=
Received: from EUR03-AM5-obe.outbound.protection.outlook.com
 (mail-am5eur03lp2052.outbound.protection.outlook.com [104.47.8.52]) (Using
 TLS) by relay.mimecast.com with ESMTP id
 de-mta-15-qNIXxe1qOx6LvSet4uKX3Q-1; Fri, 21 Aug 2020 13:50:59 +0200
X-MC-Unique: qNIXxe1qOx6LvSet4uKX3Q-1
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=nwUuefHw+nv2IQSjdGFILLY3ZxoZlpxLJd4TlWaEkqzJpQo97bw/QcsfdD9OvKUO+n0mTnPP1StbMNQcE2aiSQq10+C18pdwB60Goc1hQGXrvetb6cHUPyGcLX/ddu9yXeRWaW/zJTAilVf2ZWTUe1QM1jdlkjH2PkmHcWHwui7Z5c5WBUBt80VcGgaejypVjcCYERHtYvxctskwiraVGxjbEWK6ZsLPcg2YkOYvWyQ0ITd1f8II+0PoElWuBWVGwMu+FDNkviPoAffSZECcwBocyUmaiEQYvvjtks3XgZ3D+w3s9GgbNqVD7NnQKcnQun4SxMcwrYIyR1FSR0mNOA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=2C830VDPw2ZVUFr1h2DS3Hdh/c9bxaIApSI1yjlLUEM=;
 b=Kiwgjg870WcXMxem3uFS0hScRqe0STkmegcir8SAqUojKY5unpHIs7CD2Fv90yN+CHcz2bsvQRYpS7qKAPo2qMYX1JAEjcnWFo1HopDHTSx74WX2AFKF1G7AE4TxFCxUvV5jHjRM3Ip+vd3i0XaGfCM0j6sKW+3C8ztQUa0D+IMQIb++8x+qEKcyZGxPoBALn71bonHfBY8eQaHADhVOnbpTQD5SgcBtA8PyBfkXhZAGjkC/DJMq8WBEzkVDEPyr3TVOsjrIWklOtu3r00A4ucnLMFLHKgotXvlMcP1vHvrE/wI9zBfzyYRaWLd6AOVbMAtkXdyAWJu7kGXFaY7bbQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=suse.com; dmarc=pass action=none header.from=suse.com;
 dkim=pass header.d=suse.com; arc=none
Authentication-Results: opensuse.org; dkim=none (message not signed)
 header.d=none;opensuse.org; dmarc=none action=none header.from=suse.com;
Received: from DB7PR04MB4793.eurprd04.prod.outlook.com (2603:10a6:10:1c::17)
 by DBAPR04MB7464.eurprd04.prod.outlook.com (2603:10a6:10:1a8::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3305.25; Fri, 21 Aug
 2020 11:50:58 +0000
Received: from DB7PR04MB4793.eurprd04.prod.outlook.com
 ([fe80::d410:4d1:ec34:45d7]) by DB7PR04MB4793.eurprd04.prod.outlook.com
 ([fe80::d410:4d1:ec34:45d7%4]) with mapi id 15.20.3283.028; Fri, 21 Aug 2020
 11:50:58 +0000
To: opensuse-factory <opensuse-factory@opensuse.org>
From: John Paul Adrian Glaubitz <adrian.glaubitz@suse.com>
Subject: [opensuse-factory] RPM %pre and %post parameters when obsoleting a package
Message-ID: <81195101-43d5-8bb9-21ba-9e40964fb8b9@suse.com>
Date: Fri, 21 Aug 2020 13:50:55 +0200
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101
 Thunderbird/68.11.0
Content-Type: text/plain; charset=utf-8
Content-Language: en-US
Content-Transfer-Encoding: 7bit
X-ClientProxiedBy: AM0PR10CA0017.EURPRD10.PROD.OUTLOOK.COM
 (2603:10a6:208:17c::27) To DB7PR04MB4793.eurprd04.prod.outlook.com
 (2603:10a6:10:1c::17)
Precedence: bulk
Mailing-List: contact opensuse-factory+help@opensuse.org; run by mlmmj
X-Mailinglist: opensuse-factory
List-Post: <mailto:opensuse-factory@opensuse.org>
List-Help: <mailto:opensuse-factory+help@opensuse.org>
List-Subscribe:  <mailto:opensuse-factory+subscribe@opensuse.org>
List-Unsubscribe:  <mailto:opensuse-factory+unsubscribe@opensuse.org>
List-Owner: <mailto:opensuse-factory+owner@opensuse.org>
List-Archive: <http://lists.opensuse.org/opensuse-factory/>
X-MIME-Notice: attachments may have been removed from this message
MIME-Version: 1.0
X-MS-Exchange-MessageSentRepresentingType: 1
Received: from [192.168.1.10] (89.14.102.180) by AM0PR10CA0017.EURPRD10.PROD.OUTLOOK.COM (2603:10a6:208:17c::27) with Microsoft SMTP Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3305.24 via Frontend Transport; Fri, 21 Aug 2020 11:50:57 +0000
X-Originating-IP: [89.14.102.180]
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: b7f81b5a-1e44-45eb-42af-08d845c877c2
X-MS-TrafficTypeDiagnostic: DBAPR04MB7464:
X-Microsoft-Antispam-PRVS:
	<DBAPR04MB746490709CCAF2B51A51CA8C805B0@DBAPR04MB7464.eurprd04.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:9508;
X-MS-Exchange-SenderADCheck: 1
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info:
	wpVtR2tL3oIS3GJ+1NpHwIe4cTdNFxAa6ckSizcI4Lr95bz2JjF22x12xWT5uz+0AEx+EQhBj2uM51r3QgiBbzT7hTnFzrw8oXO/TOrV7hMyH6WEXG/XxuzI7Nh0Ymy+Ahp8xOfmhhQjhZP6QwmsUlOTdoR5yerZWmpSbPgwyf+7QwMkakI4yDE9Xs5DQEdLwCiac9UlbuOO9+mDyBYt53ckeW3h+nBg2x72lAKEX1HOwbbzUtUS2iKGZhtDji7LsvwLnzmbBOHNy0RaIyt8xPzxfzLvX197XPBk+CBeNMXRcMZ/4voRz0VuBl+UzmMLQmilI18WkUnZ6OcN93eFjNqxtqMmEvoGGobWjnxkiCQn/IF/IgyPaKcOOxiPS99sZlhodbZKEvJGZbOmq8Z3BRacwiJDPWQTnRY7c1lzZ9pwgJPOpIqktkL5FgEVVBXwwZFLrscViPKpap6zB7jwGA==
X-Forefront-Antispam-Report:
	CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DB7PR04MB4793.eurprd04.prod.outlook.com;PTR:;CAT:NONE;SFS:(376002)(39860400002)(346002)(366004)(136003)(396003)(66476007)(2616005)(66556008)(31696002)(66946007)(6916009)(966005)(83380400001)(956004)(478600001)(8936002)(8676002)(6486002)(31686004)(186003)(36756003)(52116002)(26005)(2906002)(5660300002)(86362001)(16526019)(16576012)(316002)(43740500002);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData:
	fib0jC175lvh+CWmE0j5BnBHbEjmqKHQp8Va4qcjqAhKD/MygKIyYBGyUrHgAlxxfdnSYCcF0FTuHVeJR6uupxUMiaTd5ItilrOtc6wCwb7ZmtjZM0wihqTBUmEwpxtPKaB9n7/Cqf3v757cVmh1ZRByW83shjMvNS90UwNr5Ds1+KbrITY25hCvgS1QM4npCx0N6R6Ty4ma1GltEDBT6hHzl/YtiRTWSYFCfJt4dn0EmjZoqZDMP48TOyoArYoMygIyVp9wNjutXW+nEq16gWU/f/jk/6wOd0S2eCx40diY6yNDXrl2cy0yWZ/5CitigLH+yzT02u4cpx0bOTO7a3etMQdJpK0U+ikGL7VhDqaNQcZaR82WlV/0FFhphu+vwDv0iKeZjjyN/jJYNRjxqfcR+KEIJMOVGebXafvMKiYbOT6XVNO1E3KSfAz4iOd+iiq1dz9pbdgBE87mK5lP78v01vPcqPNKGg7VFk+xhsRhbgjx4CErnKJwswH92ghF+d6psUEz9s7rQ8/a6/VVxUG1U0owJtg/DGXujOdyrdew+mdFNpmUnk84kmiyjioQfCI7LfvRfWXdwJcjYsV2MU7yOTKtquBiJLeyAIIlc0FOn27E+6+f7idhwR/5sAoDw3rF/AIbjuV8JVyrQBu5Eg==
X-OriginatorOrg: suse.com
X-MS-Exchange-CrossTenant-Network-Message-Id: b7f81b5a-1e44-45eb-42af-08d845c877c2
X-MS-Exchange-CrossTenant-AuthSource: DB7PR04MB4793.eurprd04.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 21 Aug 2020 11:50:57.9100
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: f7a17af6-1c5c-4a36-aa8b-f5be247aa4ba
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: iDkQ0J59nJBCXbLyh2xjmmV0bbeoZEpW8EVxSuj0F9ViuqGe9iIcjaghYS3BeTNesPPMSVUB56pPQ5JCxj8C6bCrY9L9C5MP/M26uUUysek=
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DBAPR04MB7464

Hello!

I'm currently trying to solve a tricky problem with the google-compute-engine-{init,oslogin}
and google-guest-{agent,oslogin,configs} packages. The latter are replacement packages for
the former, i.e. the google-guest-* packages are obsoleting the google-compute-engine-*
packages.

The google-guest-* packages contain systemd services which need to be enabled in case the
packages are being installed as an upgrade over the old google-compute-engine-* packages.

While RPM has a mechanism for determining whether a package is being upgraded or newly
installed [1], this mechanism does not work when the upgrade process involves replacing
the old packages with a new package involving the Obsoletes+Replaces mechanism.

The reason why that doesn't work is because the scriptlet parameter that indicates the
upgrade process actually just notifies the scriptlet of the number of packages with the
same name are currently being installed which is "2" during an upgrade [1], so that
number will be "1" when google-compute-engine-oslogin is being replaced with
google-guest-oslogin, for example.

Does anyone have a suggestion how to solve this? I have been thinking about writing
a temporary file empty to the filesystem in the %pre scriptlet to disk which is then
detected by the %post scriptlet.

The empty file would be written if the old services are found as enabled in the %pre
section and the %post section would enable the services if the temporary file is
found. The file can be created with "mktemp --suffix .google-compute-engine".

Any other suggestions?

Adrian

> [1] https://docs.fedoraproject.org/en-US/packaging-guidelines/Scriptlets/#_syntax
-- 
To unsubscribe, e-mail: opensuse-factory+unsubscribe@opensuse.org
To contact the owner, e-mail: opensuse-factory+owner@opensuse.org

